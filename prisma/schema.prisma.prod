// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  phone     String   @unique // Now required for Nigerian phone number
  firstName String?
  lastName  String?
  gender    Gender   // Required: MALE, FEMALE, OTHER
  dateOfBirth DateTime // Required: User's date of birth
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auth fields
  passcode     String  // Hashed 6-digit numeric passcode (required)
  bvn          String? // Bank Verification Number (optional, used in KYC)
  isVerified   Boolean @default(false)
  isOnboarded  Boolean @default(false)

  // KYC fields
  kycStatus      KycStatus @default(PENDING)
  kycVerifiedAt  DateTime?
  selfieUrl      String?   // Uploaded selfie for verification
  bvnVerifiedAt  DateTime? // When BVN was verified
  bvnProviderResponse Json? // Raw response from BVN verification provider (Raven, etc.)
  
  // OTP verification
  otpCode      String?
  otpExpiresAt DateTime?

  // Relations
  transactions Transaction[]
  ocrScans     OcrScan[]
  wallet       Wallet?
  aiApprovals  AiApproval[]
  aiQueries    AiQuery[]

  @@map("users")
}

model Wallet {
  id            String   @id @default(cuid())
  userId        String   @unique
  balance       Float    @default(0.00)
  currency      String   @default("NGN")
  
  // Virtual account details from provider
  virtualAccountNumber String? @unique  // Generated by provider (e.g., 9038123456)
  providerId          String?           // Provider's internal account ID
  providerAccountName String?           // Account name at provider
  provider            String?           // Provider that created this wallet (BUDPAY, POLARIS, SMEPLUG)
  bankName            String?           // Bank name from the provider
  
  // Wallet security
  pin           String?  // Hashed wallet PIN
  isActive      Boolean  @default(true)
  
  // Limits and controls
  dailyLimit    Float    @default(100000)  // Daily spending limit (₦100,000)
  monthlyLimit  Float    @default(1000000) // Monthly limit (₦1,000,000)
  
  // Metadata
  lastTransactionAt DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user                User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentTransactions    WalletTransaction[] @relation("SenderWallet")
  receivedTransactions WalletTransaction[] @relation("ReceiverWallet")

  @@map("wallets")
}

model WalletTransaction {
  id          String                 @id @default(cuid())
  amount      Float
  type        WalletTransactionType
  status      TransactionStatus      @default(PENDING)
  reference   String                 @unique
  description String?
  fee         Float                  @default(0)
  
  // Sender details (for transfers and withdrawals)
  senderWalletId   String?
  senderWallet     Wallet?  @relation("SenderWallet", fields: [senderWalletId], references: [id])
  
  // Receiver details (for transfers and funding)
  receiverWalletId String?
  receiverWallet   Wallet?  @relation("ReceiverWallet", fields: [receiverWalletId], references: [id])
  
  // External bank account details (for funding/withdrawal)
  bankAccountId    String?
  bankAccount      Account? @relation(fields: [bankAccountId], references: [id])
  
  // Provider details
  providerReference String?  // Provider's transaction reference
  providerResponse  Json?    // Full provider response
  
  // Balances (for audit)
  senderBalanceBefore   Float?
  senderBalanceAfter    Float?
  receiverBalanceBefore Float?
  receiverBalanceAfter  Float?
  
  // Additional metadata
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("wallet_transactions")
}

model Account {
  id          String   @id @default(cuid())
  accountName String
  accountNumber String
  bankName    String
  bankCode    String?
  routingNumber String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Transactions from/to this account
  fromTransactions Transaction[] @relation("FromAccount")
  toTransactions   Transaction[] @relation("ToAccount")
  
  // Wallet transactions involving this bank account
  walletTransactions WalletTransaction[]

  @@unique([accountNumber, bankCode])
  @@map("accounts")
}

model Transaction {
  id            String            @id @default(cuid())
  amount        Float
  currency      String            @default("NGN")
  description   String?
  reference     String            @unique
  status        TransactionStatus @default(PENDING)
  type          TransactionType
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // User who initiated the transaction
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // From and To accounts
  fromAccountId String?
  fromAccount   Account? @relation("FromAccount", fields: [fromAccountId], references: [id])
  
  toAccountId String?
  toAccount   Account? @relation("ToAccount", fields: [toAccountId], references: [id])

  // Related OCR scan if transaction was initiated from image
  ocrScanId String?
  ocrScan   OcrScan? @relation(fields: [ocrScanId], references: [id])

  // Additional metadata
  metadata Json?

  @@map("transactions")
}

model OcrScan {
  id           String    @id @default(cuid())
  originalText String    // Raw OCR output
  cleanedText  String?   // Processed/cleaned text
  extractedData Json?    // Structured data extracted from text
  imageUrl     String?   // URL to the uploaded image
  confidence   Float?    // OCR confidence score
  status       OcrStatus @default(PROCESSING)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // User who uploaded the image
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Related transactions created from this scan
  transactions Transaction[]

  @@map("ocr_scans")
}

model AiQuery {
  id         String        @id @default(cuid())
  prompt     String        // User's question/query
  response   String?       // AI's response
  model      String        @default("gemini-2.0-flash") // AI model used
  status     AiQueryStatus @default(PROCESSING) // Query processing status
  structured Json?         // Structured query data from AI parsing
  tokens     Int?          // Number of tokens used
  confidence Float?        // AI confidence score
  category   String?       // Query category (financial, general, etc.)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // User who made the query
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_queries")
}

model FeeConfiguration {
  id                String   @id @default(cuid())
  type              FeeType  @unique
  percentage        Float?   // Fee percentage (e.g., 0.015 for 1.5%)
  fixedAmount       Float?   // Fixed fee amount
  minimumFee        Float?   // Minimum fee amount
  maximumFee        Float?   // Maximum fee amount (optional)
  isActive          Boolean  @default(true)
  description       String?  // Description of the fee
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("fee_configurations")
}

model SystemConfiguration {
  id          String            @id @default(cuid())
  key         SystemConfigKey   @unique
  value       String            // Stored as string, converted by application
  description String?           // Description of the configuration
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("system_configurations")
}

model AiApproval {
  id             String              @id @default(cuid())
  userId         String              
  approvalType   AiApprovalType      // SELFIE_KYC, etc.
  status         AiApprovalStatus    @default(APPROVED)
  aiProvider     String              // gemini, openai, etc.
  aiResponse     Json                // Full AI response for audit
  confidence     Float               // AI confidence score (0-1)
  
  // Admin review
  reviewedById   String?             // Admin who reviewed/rescinded
  reviewedAt     DateTime?           // When admin reviewed
  reviewComment  String?             // Admin comment
  
  // Metadata
  imageUrl       String?             // Path to analyzed image
  relatedData    Json?               // Additional context data
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  // Relations
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("ai_approvals")
}

// Enums
enum SystemConfigKey {
  ACTIVE_TRANSFER_PROVIDER  // Which transfer provider to use (BUDPAY, SMEPLUG, etc.)
  ACTIVE_WALLET_PROVIDER    // Which wallet provider to use (BUDPAY, POLARIS, SMEPLUG)
  DEFAULT_CURRENCY          // Default system currency
  MAINTENANCE_MODE          // System maintenance mode (true/false)
}

enum KycStatus {
  PENDING      // Initial state
  IN_PROGRESS  // BVN verification started
  VERIFIED     // Fully verified (BVN + Selfie)
  REJECTED     // KYC failed verification
}

enum AiApprovalType {
  SELFIE_KYC   // Selfie verification for KYC
  DOCUMENT_VERIFICATION // Document verification
  IDENTITY_CHECK // Identity verification
}

enum AiApprovalStatus {
  APPROVED     // AI approved, active
  RESCINDED    // Admin rescinded the approval
  UNDER_REVIEW // Admin is reviewing the approval
}

enum WalletTransactionType {
  FUNDING      // Add money from external bank to wallet
  WITHDRAWAL   // Send money from wallet to external bank
  TRANSFER     // Wallet-to-wallet transfer (internal)
  REVERSAL     // Transaction reversal/refund
  FEE          // Fee deduction
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum TransactionType {
  TRANSFER
  DEPOSIT
  WITHDRAWAL
  PAYMENT
}

enum OcrStatus {
  PROCESSING
  COMPLETED
  FAILED
}

enum FeeType {
  TRANSFER          // Wallet-to-bank transfer fee
  WITHDRAWAL        // Wallet withdrawal fee
  FUNDING           // Wallet funding fee
  CURRENCY_EXCHANGE // Currency conversion fee
  MONTHLY_MAINTENANCE // Monthly account maintenance
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AiQueryStatus {
  PROCESSING   // Query is being processed
  COMPLETED    // Query completed successfully
  FAILED       // Query processing failed
}
